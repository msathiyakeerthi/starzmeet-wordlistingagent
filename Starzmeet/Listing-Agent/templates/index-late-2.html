<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autism Services Scraper - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .animated-gradient {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #4facfe);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .card-3d {
            transition: all 0.3s ease;
        }
        .card-3d:hover {
            transform: translateY(-10px) rotateX(5deg);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .result-card {
            animation: slideIn 0.5s ease;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Hero Section -->
    <div class="animated-gradient text-white">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-heart text-3xl"></i>
                    <span class="text-2xl font-bold">Autism Services Directory</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/manage" class="bg-white bg-opacity-20 backdrop-blur-lg px-4 py-2 rounded-lg hover:bg-opacity-30 transition">
                        <i class="fas fa-cog mr-2"></i>Manage
                    </a>
                    <a href="/view_data" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition">
                        <i class="fas fa-database mr-2"></i>View Data ({{ total_places }})
                    </a>
                </div>
            </div>
        </nav>

        <div class="container mx-auto px-6 py-20 text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-6">
                Discover Autism & ADHD Services
            </h1>
            <p class="text-xl md:text-2xl mb-8 opacity-90">
                AI-powered scraper that finds and enriches autism service providers worldwide
            </p>
            <div class="flex items-center justify-center space-x-4">
                <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg px-6 py-3">
                    <div class="text-3xl font-bold">{{ total_places }}</div>
                    <div class="text-sm opacity-90">Places Scraped</div>
                </div>
                <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg px-6 py-3">
                    <div class="text-3xl font-bold">20+</div>
                    <div class="text-sm opacity-90">Search Queries</div>
                </div>
                <div class="bg-white bg-opacity-20 backdrop-blur-lg rounded-lg px-6 py-3">
                    <div class="text-3xl font-bold">AI</div>
                    <div class="text-sm opacity-90">Powered</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="container mx-auto px-6 -mt-16 relative z-10">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                <i class="fas fa-search mr-3 text-blue-600"></i>Start Scraping
            </h2>
            
            <form id="searchForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Location Input -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>Location
                        </label>
                        <input 
                            type="text" 
                            id="location" 
                            name="location"
                            value="California"
                            placeholder="e.g., California, Dubai, Singapore"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            required
                        >
                        <p class="text-xs text-gray-500 mt-1">Enter a city, state, or country</p>
                    </div>

                    <!-- Max Results Input -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-hashtag mr-2 text-purple-500"></i>Maximum Results
                        </label>
                        <input 
                            type="number" 
                            id="maxResults" 
                            name="max_results"
                            value="20"
                            min="1"
                            max="100"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            required
                        >
                        <p class="text-xs text-gray-500 mt-1">Between 1-100 (Note: Larger numbers take longer)</p>
                    </div>
                </div>

                <!-- Custom Keywords (Optional) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-tags mr-2 text-green-500"></i>Custom Search Keywords (Optional)
                    </label>
                    <textarea 
                        id="customKeywords" 
                        name="custom_keywords"
                        rows="3"
                        placeholder="autism therapy, ADHD coaching, special needs centers (comma-separated)"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1">
                        Leave empty to use default keywords. 
                        <a href="/manage" class="text-blue-600 hover:underline">Manage keywords â†’</a>
                    </p>
                </div>

                <!-- Submit Button -->
                <button 
                    type="submit" 
                    id="startButton"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition transform hover:scale-105"
                >
                    <i class="fas fa-rocket mr-2"></i>Start Scraping
                </button>
            </form>
        </div>
    </div>

    <!-- Progress Section -->
    <div id="progressSection" class="container mx-auto px-6 mt-8 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-cog fa-spin mr-3 text-blue-600"></i>Scraping in Progress...
                </h3>
                <button onclick="stopScraping()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-stop mr-2"></i>Stop
                </button>
            </div>

            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between text-sm text-gray-600 mb-2">
                    <span id="progressText">Initializing...</span>
                    <span id="progressPercentage">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="progress-bar bg-gradient-to-r from-blue-600 to-purple-600 h-full rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span><span id="completedCount">0</span> completed</span>
                    <span><span id="totalCount">0</span> total</span>
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600" id="newPlacesCount">0</div>
                    <div class="text-sm text-gray-600">New Places</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600" id="withWebsiteCount">0</div>
                    <div class="text-sm text-gray-600">With Websites</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-purple-600" id="enrichedCount">0</div>
                    <div class="text-sm text-gray-600">AI Enriched</div>
                </div>
                <div class="bg-red-50 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-red-600" id="errorCount">0</div>
                    <div class="text-sm text-gray-600">Errors</div>
                </div>
            </div>

            <!-- Current Place -->
            <div id="currentPlace" class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4">
                <div class="text-sm text-gray-600 mb-1">Currently processing:</div>
                <div class="font-semibold text-gray-800" id="currentPlaceName">Waiting...</div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" class="container mx-auto px-6 mt-8 hidden">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-check-circle mr-3 text-green-600"></i>Scraped Places
                </h3>
                <div class="flex space-x-3">
                    <button onclick="downloadCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-download mr-2"></i>Download CSV
                    </button>
                    <a href="/view_data" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-eye mr-2"></i>View All Data
                    </a>
                </div>
            </div>

            <div id="resultsContainer" class="space-y-4 max-h-[600px] overflow-y-auto">
                <!-- Results will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="container mx-auto px-6 py-16">
        <h2 class="text-4xl font-bold text-center text-gray-800 mb-12">Features</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div class="card-3d bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-robot text-3xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3">AI-Powered Enrichment</h3>
                <p class="text-gray-600">Uses GPT-4 to extract detailed business information, descriptions, and metadata from websites.</p>
            </div>

            <div class="card-3d bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-map-marked-alt text-3xl text-purple-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3">Google Maps Integration</h3>
                <p class="text-gray-600">Searches 20+ targeted queries to find autism and ADHD service providers across locations.</p>
            </div>

            <div class="card-3d bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-database text-3xl text-green-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3">Smart Deduplication</h3>
                <p class="text-gray-600">Stores results in SQLite database to avoid re-scraping existing places and wasting API credits.</p>
            </div>

            <div class="card-3d bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-share-alt text-3xl text-red-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3">Social Media Extraction</h3>
                <p class="text-gray-600">Automatically finds and extracts Facebook, Instagram, Twitter, LinkedIn, and YouTube links.</p>
            </div>

            <div class="card-3d bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-clock text-3xl text-yellow-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3">Real-Time Progress</h3>
                <p class="text-gray-600">WebSocket-powered live updates showing exactly what's being scraped and enriched.</p>
            </div>

            <div class="card-3d bg-white rounded-xl shadow-lg p-8 text-center">
                <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-file-csv text-3xl text-indigo-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3">Easy Export</h3>
                <p class="text-gray-600">Download comprehensive CSV files with 30+ fields ready for directory listings or research.</p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let scrapingInProgress = false;
        let currentLocation = '';
        let stats = {
            newPlaces: 0,
            withWebsite: 0,
            enriched: 0,
            errors: 0
        };

        // Form submission
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const location = document.getElementById('location').value;
            const maxResults = document.getElementById('maxResults').value;
            
            if (!location || !maxResults) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            currentLocation = location;
            startScraping(location, maxResults);
        });

        async function startScraping(location, maxResults) {
            // Reset stats
            stats = { newPlaces: 0, withWebsite: 0, enriched: 0, errors: 0 };
            updateStats();

            // Show progress section
            document.getElementById('progressSection').classList.remove('hidden');
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultsContainer').innerHTML = '';
            
            // Disable form
            document.getElementById('startButton').disabled = true;
            document.getElementById('startButton').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Scraping...';
            
            scrapingInProgress = true;

            try {
                // Build URL with optional custom keywords
                const customKeywords = document.getElementById('customKeywords').value.trim();
                let url = `/api/search?location=${encodeURIComponent(location)}&max_results=${maxResults}`;
                if (customKeywords) {
                    url += `&keywords=${encodeURIComponent(customKeywords)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    showNotification(data.error, 'error');
                    resetUI();
                } else {
                    showNotification(`Scraping started for ${location}`, 'success');
                }
            } catch (error) {
                showNotification('Failed to start scraping: ' + error.message, 'error');
                resetUI();
            }
        }

        function stopScraping() {
            scrapingInProgress = false;
            showNotification('Scraping stopped by user', 'info');
            resetUI();
        }

        function resetUI() {
            document.getElementById('startButton').disabled = false;
            document.getElementById('startButton').innerHTML = '<i class="fas fa-rocket mr-2"></i>Start Scraping';
        }

        // Socket.IO event handlers
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('info', (data) => {
            showNotification(data.message, 'info');
        });

        socket.on('error', (data) => {
            stats.errors++;
            updateStats();
            showNotification(data.message, 'error');
        });

        socket.on('progress', (data) => {
            if (!scrapingInProgress && data.completed > 0) {
                scrapingInProgress = true;
            }

            // Update progress bar
            if (data.total > 0) {
                const percentage = (data.completed / data.total) * 100;
                document.getElementById('progressBar').style.width = percentage + '%';
                document.getElementById('progressPercentage').textContent = Math.round(percentage) + '%';
                document.getElementById('completedCount').textContent = data.completed;
                document.getElementById('totalCount').textContent = data.total;
                document.getElementById('progressText').textContent = data.message || `Processing ${data.completed} of ${data.total}...`;
            }

            // Update current place
            if (data.place) {
                document.getElementById('currentPlaceName').textContent = data.place.Title;
                
                // Update stats
                if (data.place.Status === 'New') {
                    stats.newPlaces++;
                }
                if (data.place.Website) {
                    stats.withWebsite++;
                }
                if (data.place.Description) {
                    stats.enriched++;
                }
                updateStats();

                // Add to results
                addResultCard(data.place);
            }

            // Check if completed
            if (data.completed === data.total && data.total > 0) {
                setTimeout(() => {
                    showNotification('Scraping completed successfully!', 'success');
                    resetUI();
                    scrapingInProgress = false;
                }, 1000);
            }
        });

        socket.on('retry_progress', (data) => {
            showNotification(`Retried enrichment for: ${data.place.Title}`, 'info');
            updateResultCard(data.place);
        });

        function updateStats() {
            document.getElementById('newPlacesCount').textContent = stats.newPlaces;
            document.getElementById('withWebsiteCount').textContent = stats.withWebsite;
            document.getElementById('enrichedCount').textContent = stats.enriched;
            document.getElementById('errorCount').textContent = stats.errors;
        }

        function addResultCard(place) {
            const container = document.getElementById('resultsContainer');
            const card = createResultCard(place);
            container.insertBefore(card, container.firstChild);
            
            // Limit to 50 visible cards
            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        function updateResultCard(place) {
            const cards = document.querySelectorAll('.result-card');
            cards.forEach(card => {
                if (card.dataset.placeId === place['Place ID']) {
                    const newCard = createResultCard(place);
                    card.replaceWith(newCard);
                }
            });
        }

        function createResultCard(place) {
            const card = document.createElement('div');
            card.className = 'result-card bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 border-l-4 border-blue-600';
            card.dataset.placeId = place['Place ID'];
            
            card.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-2">
                            ${place['Logo Image'] ? `<img src="${place['Logo Image']}" alt="Logo" class="w-10 h-10 rounded-full object-cover">` : ''}
                            <div>
                                <h4 class="font-bold text-gray-800">${place.Title}</h4>
                                <p class="text-xs text-gray-600">${place['Google Address'] || place.Location || 'Location not available'}</p>
                            </div>
                        </div>
                        ${place.Tagline ? `<p class="text-sm text-gray-700 italic mb-2">${place.Tagline}</p>` : ''}
                        <div class="flex items-center space-x-4 text-xs text-gray-600">
                            ${place.Phone ? `<span><i class="fas fa-phone mr-1"></i>${place.Phone}</span>` : ''}
                            ${place.Website ? `<a href="${place.Website}" target="_blank" class="text-blue-600 hover:underline"><i class="fas fa-globe mr-1"></i>Website</a>` : ''}
                            ${place.Category ? `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">${place.Category}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col items-end space-y-2">
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${place.Status === 'New' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${place.Status}
                        </span>
                        ${place.Description ? '<span class="text-xs text-green-600"><i class="fas fa-check-circle mr-1"></i>Enriched</span>' : ''}
                    </div>
                </div>
            `;
            
            return card;
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-yellow-600'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };
            
            notification.className = `notification ${colors[type]} text-white rounded-lg shadow-lg p-4 mb-4`;
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas ${icons[type]} text-xl"></i>
                        <span>${message}</span>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function downloadCSV() {
            window.location.href = `/api/download?location=${encodeURIComponent(currentLocation)}`;
        }
    </script>
</body>
</html>

